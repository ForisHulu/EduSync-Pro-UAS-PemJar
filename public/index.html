<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduSync Pro - Real-time Learning</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #007bff;
            --bg-dark: #121212;
            --bg-card: #ffffff;
            --text-main: #2d3436;
            --success: #2ecc71;
            --danger: #e74c3c;
            --sidebar-width: 360px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-dark); height: 100vh; overflow: hidden; display: flex; }

        /* --- LAYOUT UTAMA --- */
        .main-wrapper { display: flex; width: 100vw; height: 100vh; }

        /* --- AREA VIDEO (KIRI) --- */
        .video-section { flex: 1; position: relative; display: flex; flex-direction: column; background: #000; padding: 20px; }
        
        #video-grid { 
            flex: 1; 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 15px; 
            align-content: center;
            justify-content: center;
        }

        .video-container { 
            position: relative; 
            background: #1e1e1e; 
            border-radius: 12px; 
            overflow: hidden; 
            aspect-ratio: 16/9;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* PERBAIKAN MIRROR */
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Hanya class ini yang akan terbalik (untuk kamera) */
       /* .mirror-effect { transform: scaleX(-1); } */
        
        .user-label { 
            position: absolute; bottom: 10px; left: 10px; 
            background: rgba(0,0,0,0.6); color: white; 
            padding: 4px 12px; border-radius: 20px; font-size: 12px;
            backdrop-filter: blur(4px);
        }

        /* Video Controls */
        .bottom-controls { 
            height: 80px; display: flex; justify-content: center; align-items: center; gap: 15px;
        }
        .btn-round { 
            width: 50px; height: 50px; border-radius: 50%; border: none; 
            background: #333; color: white; cursor: pointer; transition: 0.3s;
            font-size: 18px; display: flex; align-items: center; justify-content: center;
        }
        .btn-round:hover { background: #444; transform: translateY(-2px); }
        .btn-round.active { background: var(--primary); }
        .btn-leave { background: var(--danger); }

        /* --- SIDEBAR INTERAKSI (KANAN) --- */
        .sidebar { 
            width: var(--sidebar-width); 
            background: #f8f9fa; 
            display: flex; flex-direction: column;
            border-left: 1px solid #dee2e6;
        }

        .sidebar-header { 
            padding: 20px; background: #fff; border-bottom: 1px solid #eee;
            display: flex; align-items: center; gap: 10px; font-weight: 700; color: var(--primary);
        }

        .scroll-area { flex: 1; overflow-y: auto; padding: 15px; }

        /* Card Component */
        .widget-card { 
            background: white; border-radius: 12px; padding: 16px; margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #efefef;
        }
        .widget-title { font-size: 13px; font-weight: 800; color: #95a5a6; text-transform: uppercase; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }

        /* Barometer UI */
        .sentiment-bar { height: 30px; background: #f1f2f6; border-radius: 8px; overflow: hidden; display: flex; margin-bottom: 10px; }
        #barPaham { background: var(--success); width: 0%; transition: 0.5s; }
        #barBingung { background: var(--danger); width: 0%; transition: 0.5s; }

        /* Queue List UI */
        .q-item { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 10px; background: #fbfbfb; border-radius: 8px; margin-bottom: 8px;
            border: 1px solid #f0f0f0;
        }
        .q-name { font-weight: 600; font-size: 14px; color: var(--text-main); }

        /* Chat UI */
      /* --- PERBAIKAN CHAT AGAR SEPERTI SEMULA --- */
.chat-display { 
    height: 250px; 
    overflow-y: auto; 
    display: flex; 
    flex-direction: column; 
    gap: 12px; 
    padding: 15px; 
    background: #ffffff; /* Background putih bersih */
    border: 1px solid #f0f0f0;
    border-radius: 8px;
    margin-bottom: 10px;
}

.msg { 
    max-width: 85%; 
    padding: 10px 14px; 
    border-radius: 15px; 
    font-size: 13px; 
    line-height: 1.5; 
    position: relative;
    word-wrap: break-word;
}

/* Chat dari SAYA (Kanan - Biru) */
.msg.me { 
    align-self: flex-end; 
    background: var(--primary); 
    color: white; 
    border-bottom-right-radius: 2px; 
    box-shadow: 0 2px 5px rgba(0,123,255,0.2);
}

/* Chat dari ORANG LAIN (Kiri - Abu-abu) */
.msg.other { 
    align-self: flex-start; 
    background: #f1f2f6; 
    color: #2d3436; 
    border-bottom-left-radius: 2px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

/* Tambahan agar nama pengirim terlihat jelas di atas bubble */
.msg-sender { 
    font-size: 10px; 
    font-weight: 800; 
    margin-bottom: 4px; 
    display: block; 
    text-transform: uppercase;
    opacity: 0.7;
}
        /* Buttons Custom */
        .btn-action { 
            width: 100%; padding: 12px; border: none; border-radius: 8px; 
            font-weight: 700; cursor: pointer; transition: 0.2s; margin-top: 5px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: #fff; color: var(--text-main); border: 1px solid #ddd; }

        /* --- POPUP VOTE --- */
        #voteOverlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000;
            display: flex; align-items: center; justify-content: center; backdrop-filter: blur(8px);
        }
        .vote-window { 
            background: white; padding: 40px; border-radius: 24px; text-align: center; width: 90%; max-width: 400px;
        }

        /* --- LOGIN --- */
        #loginOverlay { position: fixed; inset: 0; background: #fff; z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .login-card { width: 100%; max-width: 380px; padding: 40px; text-align: center; }
        .custom-inp { width: 100%; padding: 12px; border: 2px solid #f1f2f6; border-radius: 10px; outline: none; transition: 0.3s; }
        .custom-inp:focus { border-color: var(--primary); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-card">
            <h1>EduSync <span style="font-weight:300; color:#ccc;">Pro</span></h1>
            <div style="text-align:left; margin-bottom:15px;">
                <label style="font-size:12px; font-weight:700; color:#7f8c8d;">PILIH PERAN</label>
                <select id="roleInp" class="custom-inp">
                    <option value="mahasiswa">Mahasiswa</option>
                    <option value="dosen">Dosen (Host)</option>
                </select>
            </div>
            <div style="text-align:left; margin-bottom:15px;">
                <label style="font-size:12px; font-weight:700; color:#7f8c8d;">NAMA LENGKAP</label>
                <input type="text" id="nameInp" class="custom-inp" placeholder="...">
            </div>
            <div style="text-align:left; margin-bottom:15px;">
                <label style="font-size:12px; font-weight:700; color:#7f8c8d;">NOMOR INDUK (NIP/NPM)</label>
                <input type="text" id="idInp" class="custom-inp" placeholder="NIP (5) / NPM (9)" maxlength="9">
            </div>
            <button class="btn-action btn-primary" style="padding: 15px;" onclick="initApp()">MASUK KE RUANG KELAS</button>
        </div>
    </div>

    <div id="voteOverlay" class="hidden">
    <div class="vote-window">
        <i class="fas fa-comment-dots" style="font-size: 40px; color: var(--primary); margin-bottom: 15px;"></i>
        <h2 id="voteStatusTitle">Cek Pemahaman</h2>
        <p id="voteInstruction" style="color: #666; margin-bottom: 20px; font-size: 14px;">Silakan pilih kondisi Anda saat ini:</p>
        
        <div id="voteStep1" style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="btn-action" style="background:var(--success); color:white;" onclick="selectVote('PAHAM')">PAHAM ‚úÖ</button>
            <button class="btn-action" style="background:var(--danger); color:white;" onclick="selectVote('BINGUNG')">BINGUNG ‚ùå</button>
        </div>

        <div id="voteStep2" class="hidden">
            <textarea id="voteReason" class="custom-inp" style="height: 80px; margin-bottom: 15px; font-family: inherit;" placeholder="Berikan alasan singkat (opsional)..."></textarea>
            <button class="btn-action btn-primary" onclick="finalSubmitVote()">KIRIM FEEDBACK</button>
            <button class="btn-action btn-outline" style="margin-top:5px; font-size: 12px;" onclick="cancelVote()">Batal</button>
        </div>
    </div>
</div>

    <div class="main-wrapper">
        <div class="video-section">
            <div id="video-grid">
                <div class="video-container" id="localContainer">
                    <video id="localVideo" autoplay muted playsinline class="mirror-effect"></video>
                    <div class="user-label">Anda</div>
                </div>
            </div>
            
            <div class="bottom-controls">
                <button class="btn-round" id="micBtn" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
                <button class="btn-round" id="camBtn" onclick="toggleCam()"><i class="fas fa-video"></i></button>
                <button class="btn-round" id="screenBtn" onclick="toggleScreenShare()"><i class="fas fa-desktop"></i></button>
                <button class="btn-round btn-leave" onclick="location.reload()"><i class="fas fa-phone-slash"></i></button>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-graduation-cap"></i> <span id="displayUserName">EduSync Pro</span>
            </div>

            <div class="scroll-area">
                <div class="widget-card">
                    <div class="widget-title"><i class="fas fa-chart-bar"></i> Barometer Pemahaman</div>
                    <div class="sentiment-bar">
                        <div id="barPaham"></div>
                        <div id="barBingung"></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:700;">
                        <span style="color:var(--success)" id="labelPaham">PAHAM: 0</span>
                        <span style="color:var(--danger)" id="labelBingung">BINGUNG: 0</span>
                    </div>
                    <div id="dosenVoteTools" class="hidden" style="margin-top:15px;">
                        <button class="btn-action btn-primary" onclick="startCekPemahaman()">üöÄ Cek Pemahaman</button>
                    </div>
                </div>

                <div class="widget-card">
                    <div class="widget-title"><i class="fas fa-hand-paper"></i> Antrian Bertanya</div>
                    <div id="queueListContainer"></div>
                    <button id="btnMhsIzin" class="btn-action btn-primary hidden" onclick="requestQueue()">IZIN BICARA</button>
                    <div id="dosenQueueTools" class="hidden" style="margin-top:10px; display:flex; gap:5px;">
                        <button class="btn-action" style="background:var(--success); color:white; flex:2;" onclick="nextQueue()">NEXT</button>
                    </div>
                </div>

                <div class="widget-card">
                    <div class="widget-title"><i class="fas fa-comments"></i> Chat Kelas</div>
                    <div class="chat-display" id="chatBox"></div>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="chatInput" class="custom-inp" placeholder="Ketik pesan...">
                        <button onclick="sendChat()" class="btn-round" style="width:40px; height:40px; background:var(--primary);"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>